<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Validador de Constancias ITD</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web2/main/image.jpg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
    // ============================================================================
    // CONSTANTS & TYPES
    // ============================================================================
    const DATABASE_URL = 'https://raw.githubusercontent.com/DA-itd/web2/main/database.xlsx';
    const ITD_LOGO_URL = 'https://raw.githubusercontent.com/DA-itd/web2/main/image.jpg';
    const TECNM_LOGO_URL = 'https://raw.githubusercontent.com/DA-itd/web2/main/TecNM_logo.jpg';
    const VALIDATION_URL = 'https://da-itd.github.io/web2'; // URL Base para el QR

    const POTENTIAL_FOLIO_HEADERS = [
        'Folio', 'ID', 'Folio del certificado', 'Folio de la constancia',
        'No. de Folio', '# Folio', 'folio'
    ];

    const ValidationStatus = {
        IDLE: 'idle',
        SUCCESS: 'success',
        NOT_FOUND: 'not_found',
        ERROR: 'error',
    };

    // ============================================================================
    // UTILS
    // ============================================================================
    const getProperty = (obj, keyName) => {
        if (!obj || typeof obj !== 'object' || !keyName) return undefined;
        const keyToFind = keyName.toLowerCase();
        const foundKey = Object.keys(obj).find(k => k.trim().toLowerCase() === keyToFind);
        return foundKey ? obj[foundKey] : undefined;
    };

    const getFlexibleProperty = (obj, keys) => {
        if (!obj || typeof obj !== 'object' || !Array.isArray(keys)) return undefined;
        for (const key of keys) {
            const value = getProperty(obj, key);
            if (value !== undefined && value !== null) return value;
        }
        return undefined;
    };
    
    const formatDate = (dateValue) => {
        if (dateValue === undefined || dateValue === null) return 'N/A';
        if (typeof dateValue === 'string') {
            if (!isNaN(dateValue) && !isNaN(parseFloat(dateValue))) {
                let date = new Date((parseFloat(dateValue) - 25569) * 86400 * 1000);
                date = new Date(date.valueOf() + date.getTimezoneOffset() * 60000);
                if (isNaN(date.getTime())) return String(dateValue);
                return date.toLocaleDateString('es-ES',{ day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' }).toUpperCase();
            }
            return dateValue.toUpperCase();
        }
        let date;
        if (typeof dateValue === 'number') {
            date = new Date((dateValue - 25569) * 86400 * 1000);
            date = new Date(date.valueOf() + date.getTimezoneOffset() * 60000);
        } else {
            date = new Date(dateValue);
        }
        if (!date || isNaN(date.getTime())) return String(dateValue).toUpperCase();
        return date.toLocaleDateString('es-ES',{ day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' }).toUpperCase();
    };

    const audioCache = {};
    const SOUND_URLS = {
        'beep-success': 'https://github.com/google-gemini/cookbook/raw/main/examples/web/data/success.mp3',
        'beep-fail': 'https://github.com/google-gemini/cookbook/raw/main/examples/web/data/error.mp3',
    };

    const playSound = (id) => {
        let sound = audioCache[id];
        if (!sound) {
            const url = SOUND_URLS[id];
            if (!url) return;
            sound = new Audio(url);
            audioCache[id] = sound;
        }
        sound.currentTime = 0;
        sound.play().catch(error => console.warn(`Advertencia al reproducir sonido (${id}):`, error.message));
    };

    // ============================================================================
    // PDF SERVICE
    // ============================================================================
    const getImageDataFromURL = (url) => {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          if (ctx) {
            ctx.drawImage(img, 0, 0);
            const dataURL = canvas.toDataURL('image/jpeg');
            resolve({ dataURL, width: img.width, height: img.height });
          } else {
            reject(new Error('Could not get canvas context.'));
          }
        };
        img.onerror = (err) => reject(err);
        img.src = url;
      });
    };

    const getPdfDisplayValue = (key, value) => {
      if (value === null || value === undefined) return 'N/A';
      let valueStr = String(value).trim();
      if (key === 'Fecha') return formatDate(value);
      if (key === 'Duración') {
         const upperValue = valueStr.toUpperCase();
         if (upperValue.includes('HORAS')) return upperValue;
         if (!isNaN(parseFloat(valueStr)) && valueStr !== '') return `${valueStr} HORAS`;
         return upperValue;
      }
      return valueStr.toUpperCase();
    };
    
    const generateVerificationHash = (data) => {
      const folio = data.folio || '';
      const nombre = data.nombre || '';
      const fecha = data.fecha || '';
      
      const dataString = `${folio}${nombre}${fecha}`.toUpperCase().replace(/\s/g, '');
      
      let hash = 0;
      for (let i = 0; i < dataString.length; i++) {
        const char = dataString.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      
      return Math.abs(hash).toString(16).toUpperCase().padStart(8, '0');
    };

    const formatVerificationCode = (hash, folio) => {
      const folioShort = folio.replace('TNM-054-', '').replace(/-/g, '');
      return `${hash.slice(0, 4)}-${hash.slice(4, 8)}-${folioShort}`;
    };

    const generatePdf = async (result) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        try {
            const [itdLogo, tecNmLogo] = await Promise.all([
                getImageDataFromURL(ITD_LOGO_URL),
                getImageDataFromURL(TECNM_LOGO_URL)
            ]);
            
            const itdAspectRatio = itdLogo.width / itdLogo.height;
            const itdPdfImageHeight = 25;
            const itdPdfImageWidth = itdPdfImageHeight * itdAspectRatio;
            doc.addImage(itdLogo.dataURL, 'JPEG', 15, 12, itdPdfImageWidth, itdPdfImageHeight);

            const tecNmAspectRatio = tecNmLogo.width / tecNmLogo.height;
            const tecNmpdfImageHeight = 20;
            const tecNmpdfImageWidth = tecNmpdfImageHeight * tecNmAspectRatio;
            const tecNmXPosition = doc.internal.pageSize.getWidth() - 15 - tecNmpdfImageWidth;
            doc.addImage(tecNmLogo.dataURL, 'JPEG', tecNmXPosition, 12, tecNmpdfImageWidth, tecNmpdfImageHeight);

        } catch (error) {
            console.error("No se pudieron cargar los logos para el PDF:", error);
        }

        doc.setFontSize(100);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(230, 230, 230);
        doc.setGState(new doc.GState({opacity: 0.5})); 
        doc.text("VALIDO", 105, 160, { align: 'center', angle: 45 });
        doc.setGState(new doc.GState({opacity: 1})); 

        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0); 
        doc.text("TECNOLÓGICO NACIONAL DE MÉXICO", 105, 20, { align: 'center' });
        doc.text("INSTITUTO TECNOLÓGICO DE DURANGO", 105, 27, { align: 'center' });
        
        const documentTypeRaw = getFlexibleProperty(result, ['tipo']);
        const documentType = documentTypeRaw ? String(documentTypeRaw).trim().toLowerCase() : '';
        
        let titleText = 'Documento de Validez';
        if (documentType === 'constancia') titleText = 'Constancia de Validez';
        else if (documentType === 'reconocimiento') titleText = 'Reconocimiento de Validez';

        doc.setFontSize(18);
        doc.text(titleText, 105, 45, { align: 'center' });
        
        const data = {
            'Folio': getFlexibleProperty(result, ['Folio', 'ID']),
            'Nombre del Titular': getFlexibleProperty(result, ['Nombre', 'Nombre del Titular']),
            'Curso/Taller': getFlexibleProperty(result, ['Curso', 'Nombre del curso-taller']),
            'Fecha': getFlexibleProperty(result, ['Fecha', 'Fecha del curso-taller']),
            'Departamento': getFlexibleProperty(result, ['Departamento']),
            'Duración': getFlexibleProperty(result, ['Duracion', 'Duración']),
        };
        
        let y = 65;
        doc.setFontSize(11);
        Object.entries(data).forEach(([key, value]) => {
            if (value === undefined || value === null) return;
            doc.setFont("helvetica", "bold");
            doc.text(`${key}:`, 20, y);
            doc.setFont("helvetica", "normal");
            const displayValue = getPdfDisplayValue(key, value);
            const lines = doc.splitTextToSize(displayValue, 120);
            doc.text(lines, 70, y);
            y += (lines.length * 7) + 5;
        });

        y += 5;
        doc.setLineWidth(0.2);
        doc.line(20, y, 190, y);
        y += 7; 

        // ==================================================================
        // ===== SECCIÓN DEL SELLO DIGITAL (MODIFICADA PARA USAR QR) =====
        // ==================================================================
        doc.setFontSize(9);
        doc.setTextColor(100, 100, 100);
        doc.setFont("helvetica", "bold");
        doc.text("SELLO DE VERIFICACIÓN DIGITAL", 20, y);

        try {
            // 1. Generar datos del QR y Sello
            const fullFolio = data['Folio'] || 'N/A';
            // Extraer solo el sufijo para la URL, ej: 93-2025-17
            const folioSuffix = fullFolio.replace('TNM-054-', ''); 
            const qrContent = `${VALIDATION_URL}?folio=${folioSuffix}`;
            
            // 2. Generar el DataURL del QR
            // window.QRious ya existe gracias al script que añadimos
            const qr = new QRious({ 
                value: qrContent,
                level: 'M', // Nivel de corrección de errores (Medium)
                size: 150 // Resolución interna del QR
            });
            const qrDataURL = qr.toDataURL(); // Esto es un string 'data:image/png;base64,...'

            // 3. Dibujar el QR en el PDF
            const qrSize = 30; // 30mm x 30mm
            const qrX = 20;
            const qrY = y + 3;
            doc.addImage(qrDataURL, 'PNG', qrX, qrY, qrSize, qrSize);

            // 4. Generar código de verificación (sello)
            const verificationData = {
                folio: fullFolio,
                nombre: data['Nombre del Titular'] || '',
                fecha: data['Fecha'] || ''
            };
            const hash = generateVerificationHash(verificationData);
            const verificationCode = formatVerificationCode(hash, fullFolio);
            
            // 5. Dibujar el texto al lado del QR
            const textX = qrX + qrSize + 5; // Inicia después del QR
            let textY = qrY + 5; // Alineado con el QR
            
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.setFont("helvetica", "normal");
            
            doc.text("Este documento ha sido verificado digitalmente", textX, textY);
            doc.text("por el Instituto Tecnológico de Durango.", textX, textY + 4);
            
            const now = new Date();
            doc.text(`Generado: ${now.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}`, textX, textY + 10);
            doc.text(`Hora: ${now.toLocaleTimeString('es-ES')}`, textX, textY + 14);
            
            // Código de verificación (destacado)
            textY += 20;
            doc.setFontSize(7);
            doc.setTextColor(100, 100, 100);
            doc.setFont("helvetica", "bold");
            doc.text("CÓDIGO DE VERIFICACIÓN:", textX, textY);
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 139);
            doc.setFont("courier", "bold");
            doc.text(verificationCode, textX, textY + 4);
            
            // Nota de verificación
            doc.setFontSize(7);
            doc.setTextColor(120, 120, 120);
            doc.setFont("helvetica", "italic");
            doc.text("Valide este documento escaneando el QR.", textX, textY + 9);
            
        } catch (error) {
            console.error("Error al generar sello digital y QR:", error);
            doc.setFontSize(8);
            doc.setTextColor(255, 0, 0);
            doc.text("Error al crear sello digital.", 20, y + 15);
        }
        // ==================================================================
        // ===== FIN DE LA SECCIÓN MODIFICADA =====
        // ==================================================================

        doc.save(`Validacion-${data['Folio']}.pdf`);
    };

    // ============================================================================
    // DATABASE SERVICE
    // ============================================================================
    const loadDatabase = async () => {
      const cacheBustingUrl = `${DATABASE_URL}?v=${new Date().getTime()}`;
      const response = await fetch(cacheBustingUrl);
      if (!response.ok) throw new Error('No se pudo cargar la base de datos.');
      
      const arrayBuffer = await response.arrayBuffer();
      const data = new Uint8Array(arrayBuffer);

      if (data.length < 4 || data[0] !== 0x50 || data[1] !== 0x4B) {
        throw new Error('El archivo descargado no es un Excel (.xlsx) válido. Verifique la URL.');
      }

      const workbook = XLSX.read(data, { type: 'array' });
      let allData = [];

      workbook.SheetNames.forEach(sheetName => {
        const worksheet = workbook.Sheets[sheetName];
        if (!worksheet || !worksheet['!ref']) return;
        
        const dataAoA = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false });
        if (dataAoA.length === 0) return;

        let headerRowIndex = -1;
        for (let i = 0; i < dataAoA.length; i++) {
          if (Array.isArray(dataAoA[i]) && dataAoA[i].some(cell => POTENTIAL_FOLIO_HEADERS.includes(String(cell || '').trim().toLowerCase()))) {
            headerRowIndex = i;
            break;
          }
        }
        if (headerRowIndex === -1) return;

        const headers = dataAoA[headerRowIndex].map(h => (h ? String(h).trim() : ''));
        const dataRows = dataAoA.slice(headerRowIndex + 1);

        const sheetJson = dataRows
          .filter(row => Array.isArray(row) && row.some(cell => String(cell || '').trim() !== ''))
          .map(row => {
            const record = headers.reduce((acc, header, i) => {
              if (header && i < row.length && row[i] !== undefined && row[i] !== null) {
                acc[header] = row[i];
              }
              return acc;
            }, {});
            return record;
          });
          
        allData = allData.concat(sheetJson);
      });
      return allData;
    };

    // ============================================================================
    // REACT COMPONENTS
    // ============================================================================
    const { useState, useEffect, useCallback } = React;

    const SpinnerIcon = (props) => (
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" {...props}>
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    );
    
    const Header = () => (
      <header className="bg-white shadow-sm w-full">
        <div className="container mx-auto px-6 py-4 flex items-center">
          <img src={ITD_LOGO_URL} alt="Logo ITD" className="h-16 mr-4" />
          <h1 className="text-lg sm:text-xl font-bold text-gray-800">Validador de Constancias y Reconocimientos del ITD</h1>
        </div>
      </header>
    );

    const Footer = () => (
      <footer className="w-full bg-white shadow-sm mt-auto">
        <div className="container mx-auto px-6 py-4 text-center text-gray-600 text-sm">
          <p>&copy; {new Date().getFullYear()} Instituto Tecnológico de Durango. Todos los derechos reservados.</p>
          <p className="mt-1">Desarrollado por el Departamento de Sistemas y Computación. Ver 2.1 (QR)</p>
        </div>
      </footer>
    );

    const SearchForm = ({ query, setQuery, onSearch, onClear, mode, setMode }) => {
      const handleSearch = (e) => {
        e.preventDefault();
        onSearch(query);
      };

      return (
        <div className="bg-white p-6 sm:p-8 rounded-xl shadow-md w-full max-w-2xl mx-auto">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold text-gray-800">Buscar Constancia</h2>
            <div className="flex gap-2">
              <button
                onClick={() => setMode('folio')}
                className={`px-4 py-2 rounded-md font-semibold text-sm ${
                  mode === 'folio' 
                    ? 'bg-blue-600 text-white' 
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
              >
                Por Folio
              </button>
              <button
                onClick={() => setMode('code')}
                className={`px-4 py-2 rounded-md font-semibold text-sm ${
                  mode === 'code' 
                    ? 'bg-blue-600 text-white' 
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
              >
                Por Código
              </button>
            </div>
          </div>

          {mode === 'folio' ? (
            <>
              <p className="text-gray-600 mb-6">Ingrese el folio de la constancia para verificar su validez.</p>
              <form onSubmit={handleSearch} className="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <div className="flex-grow w-full">
                  <div className="flex w-full border border-gray-300 rounded-md focus-within:ring-2 focus-within:ring-blue-500 overflow-hidden">
                    <span className="px-3 text-gray-500 bg-gray-50 border-r border-gray-300 flex items-center whitespace-nowrap">
                      TNM-054-
                    </span>
                    <input
                      type="text"
                      className="w-full pl-4 pr-4 py-2 border-none focus:outline-none bg-transparent"
                      placeholder="93-2025-17"
                      value={query}
                      onChange={e => setQuery(e.target.value.toUpperCase())}
                      autoFocus
                    />
                  </div>
                </div>
                <div className="flex space-x-2 w-full sm:w-auto flex-shrink-0">
                  <button type="submit" className="flex-1 sm:flex-none px-6 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Verificar</button>
                  <button type="button" onClick={onClear} className="flex-1 sm:flex-none px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-md hover:bg-gray-300">Borrar</button>
                </div>
              </form>
            </>
          ) : (
            <>
              <p className="text-gray-600 mb-6">Ingrese el código de verificación de 16 caracteres que aparece en el PDF.</p>
              <form onSubmit={handleSearch} className="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <div className="flex-grow w-full">
                  <input
                    type="text"
                    className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="XXXX-XXXX-XXXXXXXX"
                    value={query}
                    onChange={e => setQuery(e.target.value.toUpperCase())}
                    autoFocus
                    maxLength="20"
                  />
                </div>
                <div className="flex space-x-2 w-full sm:w-auto flex-shrink-0">
                  <button type="submit" className="flex-1 sm:flex-none px-6 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Verificar</button>
                  <button type="button" onClick={onClear} className="flex-1 sm:flex-none px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-md hover:bg-gray-300">Borrar</button>
                </div>
              </form>
            </>
          )}
        </div>
      );
    };

    const ValidationResult = ({ status, result, mode }) => {
      const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);

      const handleDownload = async () => {
        if (!result) return;
        setIsGeneratingPdf(true);
        try {
          await generatePdf(result);
        } catch (error) {
          console.error("Error al generar PDF: ", error); 
          alert("Hubo un error al generar el PDF.");
        } finally {
          setIsGeneratingPdf(false);
        }
      };

      if (status === ValidationStatus.IDLE) return null;

      if (status === ValidationStatus.NOT_FOUND) {
        return (
          <div className="w-full max-w-2xl mx-auto mt-8 p-6 bg-red-50 border-l-4 border-red-500 animate-fade-in rounded-r-lg shadow">
            <h3 className="text-lg font-bold text-red-800">Documento no Encontrado</h3>
            <p className="text-red-700">El folio o código ingresado no fue encontrado. Verifique e intente de nuevo.</p>
          </div>
        );
      }
      
      if (status === ValidationStatus.SUCCESS && result) {
        let title = "Documento Válido";
        const type = getFlexibleProperty(result, ['tipo']);
        if(type) {
            const typeStr = String(type).toLowerCase();
            if(typeStr === 'constancia') title = 'Constancia Válida';
            if(typeStr === 'reconocimiento') title = 'Reconocimiento Válido';
        }
        
        const data = {
          'Folio': getFlexibleProperty(result, ['Folio', 'ID']),
          'Nombre del Titular': getFlexibleProperty(result, ['Nombre', 'Nombre del Titular']),
          'Curso/Taller': getFlexibleProperty(result, ['Curso', 'Nombre del curso-taller']),
          'Fecha': formatDate(getFlexibleProperty(result, ['Fecha', 'Fecha del curso-taller'])),
          'Departamento': getFlexibleProperty(result, ['Departamento']),
          'Duración': getPdfDisplayValue('Duración', getFlexibleProperty(result, ['Duracion', 'Duración'])),
        };

        return (
          <div className="w-full max-w-2xl mx-auto mt-8 bg-green-50 border-l-4 border-green-500 animate-fade-in rounded-r-lg shadow">
            <div className="p-6 flex justify-between items-center">
                <h3 className="text-lg font-bold text-green-800">{title}</h3>
                
                {mode === 'folio' && (
                  <button 
                      onClick={handleDownload} 
                      disabled={isGeneratingPdf}
                      className="flex items-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 disabled:bg-blue-400">
                      {isGeneratingPdf ? <SpinnerIcon className="animate-spin mr-2 h-5 w-5" /> : null}
                      {isGeneratingPdf ? 'Generando...' : 'Descargar Validación'}
                  </button>
                )}
            </div>
            <div className="bg-white p-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm rounded-b-lg border-t border-green-200">
              {Object.entries(data).map(([key, value]) => value ? (
                <div key={key}>
                  <p className="text-gray-500">{key}</p>
                  <p className="font-bold text-gray-800 break-words">{String(value).toUpperCase()}</p>
                </div>
              ) : null)}
            </div>
          </div>
        );
      }
      return null;
    };

    const App = () => {
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [certificateData, setCertificateData] = useState([]);
      const [query, setQuery] = useState('');
      const [status, setStatus] = useState(ValidationStatus.IDLE);
      const [result, setResult] = useState(null);
      const [mode, setMode] = useState('folio'); // 'folio' or 'code'

      useEffect(() => {
        (async () => {
          try {
            setError(null);
            setLoading(true);
            const db = await loadDatabase();
            setCertificateData(db);

            const params = new URLSearchParams(window.location.search);
            const folioFromUrl = params.get('folio');
            if (folioFromUrl) {
              const inputSuffix = folioFromUrl.trim().toUpperCase().replace('TNM-054-', '');
              setQuery(inputSuffix); 
              setMode('folio');
              
              const cleanedSuffix = inputSuffix.toLowerCase();

              const found = db.find(record => {
                const folio = getFlexibleProperty(record, POTENTIAL_FOLIO_HEADERS);
                return folio && String(folio).trim().toLowerCase().endsWith(cleanedSuffix);
              });

              if (found) {
                const fullFolio = `TNM-054-${inputSuffix}`;
                setResult({ ...found, 'Folio': fullFolio });
                setStatus(ValidationStatus.SUCCESS);
                playSound('beep-success');
              } else {
                setResult(null);
                setStatus(ValidationStatus.NOT_FOUND);
                playSound('beep-fail');
              }
            }
          } catch (e) {
            setError(e.message);
          } finally {
            setLoading(false);
          }
        })();
      }, []);

      const handleSearch = useCallback((searchQuery) => {
        if (!searchQuery || certificateData.length === 0) {
            setStatus(ValidationStatus.IDLE);
            setResult(null);
            return;
        }

        let found = null;
        const inputQuery = searchQuery.trim().toUpperCase(); 

        if (mode === 'folio') {
          // ===============================================
          // MODO FOLIO
          // ===============================================
          const cleanedSuffix = inputQuery.toLowerCase();

          found = certificateData.find(record => {
            const folio = getFlexibleProperty(record, POTENTIAL_FOLIO_HEADERS);
            return folio && String(folio).trim().toLowerCase().endsWith(cleanedSuffix);
          });

          if (found) {
            const fullFolio = `TNM-054-${inputQuery}`;
            setResult({ ...found, 'Folio': fullFolio });
            setStatus(ValidationStatus.SUCCESS);
            playSound('beep-success');
          }

        } else if (mode === 'code') {
          // ===============================================
          // MODO CÓDIGO
          // ===============================================
          const inputCode = inputQuery.replace(/-/g, '');
          
          found = certificateData.find(record => {
            let folioValue = getFlexibleProperty(record, POTENTIAL_FOLIO_HEADERS);
            if (!folioValue) return false; 
            
            folioValue = String(folioValue).trim().toUpperCase();
            let fullFolio;
            if (folioValue.startsWith('TNM-054-')) {
              fullFolio = folioValue;
            } else {
              fullFolio = `TNM-054-${folioValue}`;
            }

            const nombre = getFlexibleProperty(record, ['Nombre', 'Nombre del Titular']) || '';
            const fecha = getFlexibleProperty(record, ['Fecha', 'Fecha del curso-taller']) || '';

            const verificationData = {
              folio: fullFolio,
              nombre: nombre,
              fecha: fecha
            };
            
            const hash = generateVerificationHash(verificationData);
            const recordCode = formatVerificationCode(hash, fullFolio).replace(/-/g, ''); 
            
            return recordCode === inputCode;
          });

          if (found) {
            let folioValue = getFlexibleProperty(found, POTENTIAL_FOLIO_HEADERS);
            folioValue = String(folioValue).trim().toUpperCase();
            let fullFolio;
            if (folioValue.startsWith('TNM-054-')) {
              fullFolio = folioValue;
            } else {
              fullFolio = `TNM-054-${folioValue}`;
            }
            
            setResult({ ...found, 'Folio': fullFolio });
            setStatus(ValidationStatus.SUCCESS);
            playSound('beep-success');
          }
        }

        if (!found) {
          setResult(null);
          setStatus(ValidationStatus.NOT_FOUND);
          playSound('beep-fail');
        }
      }, [certificateData, mode]);

      const handleClear = useCallback(() => {
        setQuery('');
        setStatus(ValidationStatus.IDLE);
        setResult(null);
      }, []);

      const renderContent = () => {
        if (loading) return <p className="text-gray-600 p-8">Cargando base de datos...</p>;
        if (error) return <p className="text-red-600 p-8">{error}</p>;
        return (
            <React.Fragment>
                <SearchForm 
                  query={query} 
                  setQuery={setQuery} 
                  onSearch={handleSearch} 
                  onClear={handleClear}
                  mode={mode}
                  setMode={setMode}
                />
                
                <ValidationResult status={status} result={result} mode={mode} />
            
            </React.Fragment>
        );
      };

      return (
        <div className="min-h-screen flex flex-col items-center">
            <Header />
            <main className="flex-grow container mx-auto p-4 sm:p-6 w-full flex flex-col items-center">
                {renderContent()}
            </main>
            <Footer />
        </div>
      );
    };
    
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    </script>
</body>
</html>
